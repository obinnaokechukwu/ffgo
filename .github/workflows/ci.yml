# Continuous Integration for ffgo
name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  GO_VERSION: '1.23'

jobs:
  # Test without FFmpeg (should pass - tests mock/skip FFmpeg deps)
  test-no-ffmpeg:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run tests without FFmpeg
        run: go test -v -short ./...
        env:
          CGO_ENABLED: "0"

  # Test with FFmpeg (Linux amd64)
  test-with-ffmpeg-linux:
    runs-on: ubuntu-latest
    name: Test (Linux amd64)
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libavcodec-dev libavformat-dev libavutil-dev \
            libswscale-dev libswresample-dev libavfilter-dev libavdevice-dev

      - name: Build shim
        working-directory: shim
        run: ./build.sh

      - name: Set library path
        run: echo "LD_LIBRARY_PATH=${{ github.workspace }}/shim:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Run tests
        run: go test -v ./...
        env:
          CGO_ENABLED: "0"
          FFGO_SHIM_DIR: ${{ github.workspace }}/shim

      - name: Run integration tests
        run: go test -v -run Integration ./...
        env:
          CGO_ENABLED: "0"
          FFGO_SHIM_DIR: ${{ github.workspace }}/shim

  # Test with FFmpeg (macOS Intel)
  test-with-ffmpeg-macos-intel:
    runs-on: macos-15-intel
    name: Test (macOS Intel)
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install FFmpeg
        run: brew install ffmpeg

      - name: Build shim
        working-directory: shim
        run: ./build.sh

      - name: Set library path
        run: echo "DYLD_LIBRARY_PATH=${{ github.workspace }}/shim:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Run tests
        run: go test -v ./...
        env:
          CGO_ENABLED: "0"
          FFGO_SHIM_DIR: ${{ github.workspace }}/shim

      - name: Run integration tests
        run: go test -v -run Integration ./...
        env:
          CGO_ENABLED: "0"
          FFGO_SHIM_DIR: ${{ github.workspace }}/shim

  # Test with FFmpeg (macOS ARM64)
  test-with-ffmpeg-macos-arm64:
    runs-on: macos-15
    name: Test (macOS ARM64)
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install FFmpeg
        run: brew install ffmpeg

      - name: Build shim
        working-directory: shim
        run: ./build.sh

      - name: Set library path
        run: echo "DYLD_LIBRARY_PATH=${{ github.workspace }}/shim:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Run tests
        run: go test -v ./...
        env:
          CGO_ENABLED: "0"
          FFGO_SHIM_DIR: ${{ github.workspace }}/shim

      - name: Run integration tests
        run: go test -v -run Integration ./...
        env:
          CGO_ENABLED: "0"
          FFGO_SHIM_DIR: ${{ github.workspace }}/shim

  # Test graceful degradation without shim
  test-degraded-mode:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install FFmpeg (without building shim)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libavcodec-dev libavformat-dev libavutil-dev \
            libswscale-dev libswresample-dev libavfilter-dev

      - name: Run tests (no shim - degraded mode)
        run: go test -v ./...
        env:
          CGO_ENABLED: "0"
          # Explicitly unset shim directory to test degraded mode
          FFGO_SHIM_DIR: ""

  # Lint and vet
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

      - name: go vet
        # Disable unsafeptr check - purego intentionally uses unsafe.Pointer for C interop
        run: go vet -unsafeptr=false ./...
